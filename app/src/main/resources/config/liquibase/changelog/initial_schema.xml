<?xml version="1.0" encoding="utf-8"?>
<!--
  ~ This file is part of MystudiesMyteaching application.
  ~
  ~ MystudiesMyteaching application is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU General Public License as published by
  ~ the Free Software Foundation, either version 3 of the License, or
  ~ (at your option) any later version.
  ~
  ~ MystudiesMyteaching application is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ GNU General Public License for more details.
  ~
  ~ You should have received a copy of the GNU General Public License
  ~ along with MystudiesMyteaching application.  If not, see <http://www.gnu.org/licenses/>.
  -->

<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <property name="now" value="now()" dbms="h2"/>
    <property name="now" value="current_timestamp" dbms="postgresql"/>
    <property name="now" value="current_timestamp" dbms="oracle"/>

    <changeSet id="Add sequence for hibernate" author="Sebastian Monte" dbms="postgresql">
        <createSequence sequenceName="hibernate_sequence" startValue="1" incrementBy="1"/>
    </changeSet>

    <changeSet id="Add user table" author="Sebastian Monte">
        <createTable tableName="user">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="edu_person_principal_name" type="varchar(255)"/>
            <column name="created_by" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(50)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="Add auditing tables" author="Sebastian Monte">
        <createTable tableName="persistent_audit_event">
            <column name="event_id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="principal" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="event_date" type="timestamp"/>
            <column name="event_type" type="varchar(255)"/>
        </createTable>

        <createTable tableName="persistent_audit_event_data">
            <column name="event_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="varchar(255)"/>
        </createTable>
        <addPrimaryKey columnNames="event_id, name" tableName="persistent_audit_event_data"/>

        <createIndex indexName="idx_persistent_audit_event"
                     tableName="persistent_audit_event"
                     unique="false">
            <column name="principal" type="varchar(255)"/>
            <column name="event_date" type="timestamp"/>
        </createIndex>

        <createIndex indexName="idx_persistent_audit_event_data"
                     tableName="persistent_audit_event_data"
                     unique="false">
            <column name="event_id" type="bigint"/>
        </createIndex>

        <addForeignKeyConstraint baseColumnNames="event_id"
                                 baseTableName="persistent_audit_event_data"
                                 constraintName="fk_event_persistent_audit_event_data"
                                 referencedColumnNames="event_id"
                                 referencedTableName="persistent_audit_event"/>
    </changeSet>

    <changeSet id="Rename user table" author="Sebastian Monte">
        <renameTable oldTableName="user" newTableName="user_account"/>
    </changeSet>

    <changeSet id="Add favorite" author="Sebastian Monte">
        <createTable tableName="favorite">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="type" type="varchar(255)">
                <constraints nullable="false"></constraints>
            </column>
            <column name="user_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_user_favorite" references="user_account(id)"/>
            </column>
            <column name="order_index" type="int"/>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="Add twitter favorite" author="Sebastian Monte">
        <createTable tableName="twitter_favorite">
            <column name="id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_favorite_twitter_favorite" references="favorite(id)"/>
            </column>
            <column name="feed_type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="varchar(1000)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="Update varchar for created_by and modified_by" author="Sebastian Monte">
        <modifyDataType tableName="user_account" columnName="created_by" newDataType="varchar(255)" />
        <modifyDataType tableName="user_account" columnName="last_modified_by" newDataType="varchar(255)" />
    </changeSet>

    <changeSet id="Add rss favorite" author="Henri Meltaus">
        <createTable tableName="rss_favorite">
            <column name="id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_favorite_rss_favorite" references="favorite(id)"/>
            </column>
            <column name="url" type="varchar(1000)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="Add link favorite" author="Juho Rautio">
        <createTable tableName="link_favorite">
            <column name="id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_favorite_link_favorite" references="favorite(id)"/>
            </column>
            <column name="url" type="varchar(1000)">
                <constraints nullable="false"/>
            </column>
            <column name="provider_name" type="varchar(100)">
                <constraints nullable="true"/>
            </column>
            <column name="title" type="varchar(200)">
                <constraints nullable="true"/>
            </column>
            <column name="thumbnail_url" type="varchar(200)">
                <constraints nullable="true"/>
            </column>
            <column name="thumbnail_width" type="int">
                <constraints nullable="true"/>
            </column>
            <column name="thumbnail_height" type="int">
                <constraints nullable="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="Add unicafe favorite" author="Juho Rautio">
        <createTable tableName="unicafe_favorite">
            <column name="id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_favorite_unicafe_favorite" references="favorite(id)"/>
            </column>
            <column name="restaurantId" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="Add user settings" author="Sebastian Monte">
        <createTable tableName="user_settings">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_user_settings_user" references="user_account(id)"/>
            </column>
            <column name="carousel_image_file_name" type="varchar(500)"></column>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="Add user settings to existing users" author="Sebastian Monte">
        <sql>
            insert into user_settings(user_id, created_by)
            select id, 'system' from user_account
        </sql>
    </changeSet>

    <changeSet id="Add todo item table" author="Sebastian Monte">
        <createTable tableName="todo_item">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_todo_item_user" references="user_account(id)"/>
            </column>
            <column name="content" type="varchar(500)">
                <constraints nullable="false" />
            </column>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="Add status column to todo item" author="Sebastian Monte">
        <addColumn tableName="todo_item">
            <column name="status" type="varchar(255)" defaultValue="OPEN">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="Add useful links table" author="Marko Rautajoki">
        <createTable tableName="useful_link">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_useful_link_user" references="user_account(id)"/>
            </column>
            <column name="url" type="varchar(500)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="Add type to useful link" author="Marko Rautajoki">
        <addColumn tableName="useful_link">
            <column name="type" type="varchar(255)" defaultValue="DEFAULT">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="Add user notification table" author="Sebastian Monte">
        <createTable tableName="user_notification">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_user_notification_user" references="user_account(id)"/>
            </column>
            <column name="notification_id" type="varchar(500)">
                <constraints nullable="false" />
            </column>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="Add user avatar to user settings" author="Sebastian Monte">
        <addColumn tableName="user_settings">
            <column name="avatar_image" type="blob" />
        </addColumn>
    </changeSet>

    <changeSet id="Add orderIndex to useful link" author="Marko Rautajoki">
        <addColumn tableName="useful_link">
            <column name="order_index" type="int"/>
        </addColumn>
    </changeSet>

    <changeSet id="Rename restaurantId column" author="Sebastian Monte">
        <renameColumn tableName="unicafe_favorite"
                      oldColumnName="restaurantId"
                      newColumnName="restaurant_id" />
    </changeSet>

    <changeSet id="Add portfolio table" author="Sebastian Monte">
        <createTable tableName="portfolio">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="bigint">
                <constraints unique="true"
                             nullable="false"
                             foreignKeyName="fk_portfolio_user"
                             references="user_account(id)"/>
            </column>
            <column name="url" type="varchar(500)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="Rename portfolio path" author="Marko Rautajoki">
        <renameColumn tableName="portfolio" oldColumnName="url" newColumnName="path"/>
    </changeSet>

    <changeSet id="Add oodi person id to user_account table" author="Henri Meltaus">
        <addColumn tableName="user_account">
            <column name="oodi_person_id" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="Add default user background file name" author="Sebastian Monte">
        <sql>
            update user_settings
            set carousel_image_file_name = 'Profile_1.jpg'
            where carousel_image_file_name is null
        </sql>
    </changeSet>

    <changeSet id="Add intro and ownerName fields to portfolio" author="Marko Rautajoki">
        <addColumn tableName="portfolio">
            <column name="intro" type="varchar(500)"/>
        </addColumn>
        <addColumn tableName="portfolio">
            <column name="owner_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="Add visibility field to portfolio" author="Juho Rautio">
        <addColumn tableName="portfolio">
            <column name="visibility" type="varchar(20)" />
        </addColumn>
    </changeSet>

    <changeSet id="Set visibilities to portfolios" author="Juho Rautio">
        <sql>
            UPDATE portfolio SET visibility = 'PRIVATE';
        </sql>
    </changeSet>

    <changeSet id="Set portfolio visibility not nullable" author="Juho Rautio">
        <addNotNullConstraint tableName="portfolio" columnName="visibility" columnDataType="varchar" />
    </changeSet>

    <changeSet id="Add portfolio keyword table" author="Sebastian Monte">
        <createTable tableName="portfolio_keyword">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="title" type="varchar(50)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="Add portfolio keyword relationship table" author="Sebastian Monte">
        <createTable tableName="portfolio_keyword_relationship">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="portfolio_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_relationship_portfolio" references="portfolio(id)"/>
            </column>
            <column name="portfolio_keyword_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_relationship_portfolio_keyword" references="portfolio_keyword(id)"/>
            </column>
            <column name="order_index" type="int"/>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="Add portfolio summary text" author="Marko Rautajoki">
        <addColumn tableName="portfolio">
            <column name="summary" type="text"></column>
        </addColumn>
    </changeSet>

    <changeSet id="Add flags for showing student and teacher tours" author="Marko Rautajoki">
        <addColumn tableName="user_settings">
            <column name="show_my_studies_tour" type="int" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="show_my_teaching_tour" type="int" defaultValue="1">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="change show studies flag types to boolean" author="Marko Rautajoki">
       <dropColumn tableName="user_settings" columnName="show_my_studies_tour"></dropColumn>
       <dropColumn tableName="user_settings" columnName="show_my_teaching_tour"></dropColumn>
        <addColumn tableName="user_settings">
            <column name="show_my_studies_tour" type="boolean" defaultValue="true">
                <constraints nullable="false"/>
            </column>
            <column name="show_my_teaching_tour" type="boolean" defaultValue="true">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="Change carousel column name" author="Sebastian Monte">
        <renameColumn tableName="user_settings"
                      oldColumnName="carousel_image_file_name"
                      newColumnName="background_filename" />
    </changeSet>
    <changeSet id="Add unique constraint to oodi_person_id" author="Sebastian Monte">
        <addUniqueConstraint tableName="user_account" columnNames="oodi_person_id"/>
    </changeSet>

    <changeSet id="Add portfolio boolean to favorite" author="Marko Rautajoki">
        <addColumn tableName="favorite">
            <column name="portfolio" type="boolean" defaultValue="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="Add flag for portfolio tour to user settings" author="Marko Rautajoki">
        <addColumn tableName="user_settings">
            <column name="show_portfolio_tour" type="boolean" defaultValue="true">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="Add contact information table" author="Sebastian Monte">
        <createTable tableName="contact_information">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="portfolio_id" type="bigint">
                <constraints unique="true"
                             nullable="false"
                             foreignKeyName="fk_contact_information_portfolio"
                             references="portfolio(id)"/>
            </column>
            <column name="phone_number" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="email" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="Add some link table" author="Sebastian Monte">
        <createTable tableName="some_link">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="portfolio_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_some_link_portfolio" references="portfolio(id)"/>
            </column>
            <column name="url" type="varchar(500)">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="Add degree table" author="Sebastian Monte">
        <createTable tableName="degree">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="portfolio_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_degree_portfolio" references="portfolio(id)"/>
            </column>
            <column name="title" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(500)">
                <constraints nullable="true"/>
            </column>
            <column name="date_of_degree" type="date">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="Add delete cascades" author="Sebastian Monte">

        <dropForeignKeyConstraint baseTableName="favorite" constraintName="fk_user_favorite"/>
        <addForeignKeyConstraint baseColumnNames="user_id"
                                 baseTableName="favorite"
                                 constraintName="fk_user_favorite"
                                 referencedColumnNames="id"
                                 referencedTableName="user_account"
                                 onDelete="CASCADE"/>

        <dropForeignKeyConstraint baseTableName="twitter_favorite" constraintName="fk_favorite_twitter_favorite"/>
        <addForeignKeyConstraint baseColumnNames="id"
                                 baseTableName="twitter_favorite"
                                 constraintName="fk_favorite_twitter_favorite"
                                 referencedColumnNames="id"
                                 referencedTableName="favorite"
                                 onDelete="CASCADE"/>

        <dropForeignKeyConstraint baseTableName="rss_favorite" constraintName="fk_favorite_rss_favorite"/>
        <addForeignKeyConstraint baseColumnNames="id"
                                 baseTableName="rss_favorite"
                                 constraintName="fk_favorite_rss_favorite"
                                 referencedColumnNames="id"
                                 referencedTableName="favorite"
                                 onDelete="CASCADE"/>

        <dropForeignKeyConstraint baseTableName="link_favorite" constraintName="fk_favorite_link_favorite"/>
        <addForeignKeyConstraint baseColumnNames="id"
                                 baseTableName="link_favorite"
                                 constraintName="fk_favorite_link_favorite"
                                 referencedColumnNames="id"
                                 referencedTableName="favorite"
                                 onDelete="CASCADE"/>

        <dropForeignKeyConstraint baseTableName="unicafe_favorite" constraintName="fk_favorite_unicafe_favorite"/>
        <addForeignKeyConstraint baseColumnNames="id"
                                 baseTableName="unicafe_favorite"
                                 constraintName="fk_favorite_unicafe_favorite"
                                 referencedColumnNames="id"
                                 referencedTableName="favorite"
                                 onDelete="CASCADE"/>

        <dropForeignKeyConstraint baseTableName="user_settings" constraintName="fk_user_settings_user"/>
        <addForeignKeyConstraint baseColumnNames="user_id"
                                 baseTableName="user_settings"
                                 constraintName="fk_user_settings_user"
                                 referencedColumnNames="id"
                                 referencedTableName="user_account"
                                 onDelete="CASCADE"/>

        <dropForeignKeyConstraint baseTableName="todo_item" constraintName="fk_todo_item_user"/>
        <addForeignKeyConstraint baseColumnNames="user_id"
                                 baseTableName="todo_item"
                                 constraintName="fk_todo_item_user"
                                 referencedColumnNames="id"
                                 referencedTableName="user_account"
                                 onDelete="CASCADE"/>

        <dropForeignKeyConstraint baseTableName="useful_link" constraintName="fk_useful_link_user"/>
        <addForeignKeyConstraint baseColumnNames="user_id"
                                 baseTableName="useful_link"
                                 constraintName="fk_useful_link_user"
                                 referencedColumnNames="id"
                                 referencedTableName="user_account"
                                 onDelete="CASCADE"/>

        <dropForeignKeyConstraint baseTableName="user_notification" constraintName="fk_user_notification_user"/>
        <addForeignKeyConstraint baseColumnNames="user_id"
                                 baseTableName="user_notification"
                                 constraintName="fk_user_notification_user"
                                 referencedColumnNames="id"
                                 referencedTableName="user_account"
                                 onDelete="CASCADE"/>

        <dropForeignKeyConstraint baseTableName="portfolio" constraintName="fk_portfolio_user"/>
        <addForeignKeyConstraint baseColumnNames="user_id"
                                 baseTableName="portfolio"
                                 constraintName="fk_portfolio_user"
                                 referencedColumnNames="id"
                                 referencedTableName="user_account"
                                 onDelete="CASCADE"/>

        <dropForeignKeyConstraint baseTableName="portfolio_keyword_relationship" constraintName="fk_relationship_portfolio"/>
        <addForeignKeyConstraint baseColumnNames="portfolio_id"
                                 baseTableName="portfolio_keyword_relationship"
                                 constraintName="fk_relationship_portfolio"
                                 referencedColumnNames="id"
                                 referencedTableName="portfolio"
                                 onDelete="CASCADE"/>

        <dropForeignKeyConstraint baseTableName="portfolio_keyword_relationship" constraintName="fk_relationship_portfolio_keyword"/>
        <addForeignKeyConstraint baseColumnNames="portfolio_keyword_id"
                                 baseTableName="portfolio_keyword_relationship"
                                 constraintName="fk_relationship_portfolio_keyword"
                                 referencedColumnNames="id"
                                 referencedTableName="portfolio_keyword"
                                 onDelete="CASCADE"/>

        <dropForeignKeyConstraint baseTableName="contact_information" constraintName="fk_contact_information_portfolio"/>
        <addForeignKeyConstraint baseColumnNames="portfolio_id"
                                 baseTableName="contact_information"
                                 constraintName="fk_contact_information_portfolio"
                                 referencedColumnNames="id"
                                 referencedTableName="portfolio"
                                 onDelete="CASCADE"/>

        <dropForeignKeyConstraint baseTableName="some_link" constraintName="fk_some_link_portfolio"/>
        <addForeignKeyConstraint baseColumnNames="portfolio_id"
                                 baseTableName="some_link"
                                 constraintName="fk_some_link_portfolio"
                                 referencedColumnNames="id"
                                 referencedTableName="portfolio"
                                 onDelete="CASCADE"/>

        <dropForeignKeyConstraint baseTableName="degree" constraintName="fk_degree_portfolio"/>
        <addForeignKeyConstraint baseColumnNames="portfolio_id"
                                 baseTableName="degree"
                                 constraintName="fk_degree_portfolio"
                                 referencedColumnNames="id"
                                 referencedTableName="portfolio"
                                 onDelete="CASCADE"/>
    </changeSet>

    <changeSet id="Add portfolio study attainment whitelist table" author="Juho Rautio">
        <createTable tableName="study_attainment_whitelist">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="portfolio_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_whitelist_portfolio" references="portfolio(id)" deleteCascade="true" />
            </column>
        </createTable>
    </changeSet>
    <changeSet id="Add portfolio study attainment whitelist entry table" author="Juho Rautio">
        <createTable tableName="study_attainment_whitelist_entry">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="study_attainment_whitelist_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_whitelist_whitelist_entry" references="study_attainment_whitelist(id)" deleteCascade="true" />
            </column>
            <column name="oodi_study_attainment_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>

    </changeSet>

    <changeSet id="Add workexperience table" author="Marko Rautajoki">
        <createTable tableName="work_experience">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="portfolio_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_work_experience_portfolio" references="portfolio(id)" deleteCascade="true"/>
            </column>
            <column name="job_title" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="employer" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="start_date" type="date">
                <constraints nullable="false"/>
            </column>
            <column name="end_date" type="date">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="Add job search table" author="Marko Rautajoki">
        <createTable tableName="job_search">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="portfolio_id" type="bigint">
                <constraints unique="true" nullable="false" foreignKeyName="fk_job_search_portfolio" references="portfolio(id)" deleteCascade="true"/>
            </column>
            <column name="contact_email" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="Add component visibility table" author="Sebastian Monte">
        <createTable tableName="component_visibility">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="portfolio_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_component_visibility_portfolio"
                             references="portfolio(id)" deleteCascade="true"/>
            </column>
            <column name="component" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="visibility" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="Add calendarfeed table" author="Marko Rautajoki">
        <createTable tableName="calendar_feed">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="feed_id" type="char(36)">
                <constraints unique="true" nullable="false"/>
            </column>
            <column name="user_id" type="bigint">
                <constraints unique="true" nullable="false" foreignKeyName="fk_user_calendarfeed" references="user_account(id)" deleteCascade="true"/>
            </column>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="Add unisport favorite" author="Juho Rautio">
        <createTable tableName="unisport_favorite">
            <column name="id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_favorite_unisport_favorite" references="favorite(id)"  deleteCascade="true" />
            </column>
            <column name="url" type="varchar(1000)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="Remove url column from unisport favorite" author="Sebastian Monte">
        <dropColumn tableName="unisport_favorite" columnName="url"/>
    </changeSet>

    <changeSet id="Add unique constraint to user table" author="Sebastian Monte">
        <addUniqueConstraint tableName="user_account" columnNames="edu_person_principal_name"/>
    </changeSet>

    <changeSet id="Add localized text tables" author="Sebastian Monte">
        <createTable tableName="localized_text">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="localization">
            <column name="language_code" type="varchar(2)">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="localized_text_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_localization_localized_text" references="localized_text(id)" deleteCascade="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="Add localized url to useful link" author="Sebastian Monte">
        <addColumn tableName="useful_link">
            <column name="localized_text_id" type="bigint">
                <constraints foreignKeyName="fk_localized_url_localized_text" referencedColumnNames="localized_text(id)"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="Remove useful link url non-null constraint" author="Sebastian Monte">
        <dropNotNullConstraint tableName="useful_link" columnName="url" columnDataType="varchar(500)"/>
    </changeSet>

    <changeSet id="Add uploaded background file name to user settings" author="Sebastian Monte">
        <addColumn tableName="user_settings">
            <column name="uploaded_background_filename" type="varchar(500)"/>
        </addColumn>
    </changeSet>

    <changeSet id="Add feedback table" author="Sebastian Monte">
        <createTable tableName="feedback">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="content" type="varchar(2000)"/>
            <column name="metadata" type="varchar(2000)"/>
            <column name="created_by" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(50)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="Add number of visible items to RssFavorite" author="Juho Rautio">
        <addColumn tableName="rss_favorite">
            <column name="visible_items" type="int" />
        </addColumn>
    </changeSet>

    <changeSet id="Add visible items values to RssFavorite" author="Juho Rautio">
        <sql>UPDATE rss_favorite SET visible_items = 3</sql>
    </changeSet>

    <changeSet id="Add visible items not null constraint to RssFavorite" author="Juho Rautio">
        <addNotNullConstraint tableName="rss_favorite" columnName="visible_items" columnDataType="int" />
    </changeSet>

    <changeSet id="Add email to feedback" author="Marko Rautajoki">
        <addColumn tableName="feedback">
            <column name="email" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="Add processed to feedback" author="Juho Rautio">
        <addColumn tableName="feedback">
            <column name="processed" type="boolean" defaultValue="false"/>
        </addColumn>
    </changeSet>

    <changeSet id="Change audit event principal data type to text" author="Juho Rautio">
        <dropIndex tableName="persistent_audit_event" indexName="idx_persistent_audit_event" />
        <modifyDataType tableName="persistent_audit_event" columnName="principal" newDataType="text" />
    </changeSet>

    <changeSet id="Re-create index on persistent audit event" author="Juho Rautio" dbms="postgresql">
        <createIndex indexName="idx_persistent_audit_event"
                     tableName="persistent_audit_event"
                     unique="false">
            <column name="principal" type="text"/>
            <column name="event_date" type="timestamp"/>
        </createIndex>
    </changeSet>

    <changeSet id="Change event principal data value data type" author="Juho Rautio">
        <modifyDataType tableName="persistent_audit_event_data" columnName="value" newDataType="text" />
    </changeSet>

    <changeSet id="Add comment to feedback" author="Henri Heiskanen">
        <addColumn tableName="feedback">
            <column name="comment" type="text"/>
        </addColumn>
    </changeSet>

    <changeSet id="Add free_text_content table" author="Marko Rautajoki">
        <createTable tableName="free_text_content">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="portfolio_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_free_text_content_portfolio" references="portfolio(id)" deleteCascade="true"/>
            </column>
            <column name="title" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="text" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="Add portfolioRole column to portfolio table. Empties all portfolios and refactores unique indexes." author="Marko Rautajoki">
        <addColumn tableName="portfolio">
            <column name="portfolio_role" type="varchar(20)" defaultValue="STUDENT">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <sql>DELETE from portfolio</sql>
        <dropColumn tableName="portfolio" columnName="user_id"/>
        <dropColumn tableName="portfolio" columnName="path"/>
        <addColumn tableName="portfolio">
            <column name="user_id" type="bigint">
                <constraints nullable="false"
                             foreignKeyName="fk_portfolio_user"
                             references="user_account(id)"/>
            </column>
            <column name="path" type="varchar(500)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addUniqueConstraint
                constraintName="portfolio_unique_user_id_portfolio_role"
                tableName="portfolio"
                columnNames="user_id, portfolio_role"/>
    </changeSet>

    <changeSet id="Drop not null constraint from workexperience end date" author="Marko Rautajoki">
        <dropNotNullConstraint tableName="work_experience" columnName="end_date" columnDataType="date"></dropNotNullConstraint>
    </changeSet>

    <changeSet id="Add table for portfolio's language proficiency" author="Henri Heiskanen">
        <createTable tableName="language_proficiency">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="portfolio_id" type="bigint">
                <constraints nullable="false"
                             foreignKeyName="fk_language_proficiency_portfolio"
                             references="portfolio(id)"
                             deleteCascade="true"/>
            </column>
            <column name="language_code" type="varchar(2)">
                <constraints nullable="false"/>
            </column>
            <column name="proficiency" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>

        <addUniqueConstraint tableName="language_proficiency"
                             columnNames="portfolio_id, language_code"
                             constraintName="unique_lang_code_portfolio_id_pair"/>
    </changeSet>

    <changeSet id="Drop existing portfolios because paths have migrated to html5 urls and slugified names" author="Juho Rautio">
        <sql>DELETE from portfolio</sql>
    </changeSet>

    <changeSet id="add show_banner field to user_usettings" author="Marko Rautajoki">
        <addColumn tableName="user_settings">
            <column name="show_banner" type="boolean" defaultValue="true">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="drop visible items from rss favorite" author="Juho Rautio">
        <dropColumn tableName="rss_favorite" columnName="visible_items"></dropColumn>
    </changeSet>

    <changeSet id="add cookie consent flag to user settings" author="Henri Heiskanen">
        <addColumn tableName="user_settings">
            <column name="cookie_consent" type="boolean" defaultValue="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add portfolio section information to free_text_content" author="Henri Heiskanen">
        <addColumn tableName="free_text_content">
            <column name="teacher_portfolio_section" type="varchar(255)">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="Drop non-null constraint on component in component_visibility" author="Henri Heiskanen">
        <dropNotNullConstraint tableName="component_visibility" columnName="component" columnDataType="varchar(255)"/>
    </changeSet>

    <changeSet id="Add teacher portfolio section to component_visibility" author="Henri Heiskanen">
        <addColumn tableName="component_visibility">
            <column name="teacher_portfolio_section" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="Drop existing teacher portfolios after introducing new grouping layer between portfolio and its contents" author="Henri Heiskanen">
        <sql>DELETE from portfolio WHERE portfolio_role = 'TEACHER'</sql>
    </changeSet>

    <changeSet id="Add freetext and link url to work experience" author="Joonas Iivonen">
        <addColumn tableName="work_experience">
            <column name="employer_url" type="varchar(255)"/>
            <column name="text" type="text"/>
        </addColumn>
    </changeSet>

    <changeSet id="Add freetext and headline to job search" author="Joonas Iivonen">
        <addColumn tableName="job_search">
            <column name="headline" type="varchar(255)"/>
            <column name="text" type="text"/>
        </addColumn>
    </changeSet>

    <changeSet id="add instance name to free_text_content" author="Henri Heiskanen">
        <addColumn tableName="free_text_content">
            <column name="instance_name" type="varchar(255)">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="Add instance name to component_visibility" author="Henri Heiskanen">
        <addColumn tableName="component_visibility">
            <column name="instance_name" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="Add compound unique constraint to component_visibility" author="Henri Heiskanen">
        <addUniqueConstraint tableName="component_visibility"
                             columnNames="portfolio_id, component, teacher_portfolio_section, instance_name"
                             constraintName="unique_component_visibility_per_instance_per_section"/>
    </changeSet>

    <changeSet id="Add sample table" author="David Price">
        <createTable tableName="sample">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="portfolio_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_sample_portfolio" references="portfolio(id)" deleteCascade="true"/>
            </column>
            <column name="url" type="varchar(1000)">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="text">
            </column>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="Add fields to contact information" author="Marko Rautajoki">
        <addColumn tableName="contact_information">
            <column name="work_number" type="varchar(255)"/>
            <column name="work_mobile" type="varchar(255)"/>
            <column name="title" type="varchar(255)"/>
            <column name="faculty" type="varchar(255)"/>
            <column name="financial_unit" type="varchar(255)"/>
            <column name="work_address" type="varchar(255)"/>
            <column name="work_postcode" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="Add language to portfolio" author="Henri Heiskanen">
        <addColumn tableName="portfolio">
            <column name="language" type="varchar(2)"/>
        </addColumn>
    </changeSet>

    <changeSet id="Add not-null constraint, default value to portfolio language" author="Henri Heiskanen">
        <addNotNullConstraint tableName="portfolio"
                              columnName="language"
                              columnDataType="varchar(2)"
                              defaultNullValue="fi"/>
    </changeSet>

    <changeSet id="Drop compound unique constraint from portfolio" author="Henri Heiskanen">
        <dropUniqueConstraint tableName="portfolio"
                              constraintName="portfolio_unique_user_id_portfolio_role"/>
    </changeSet>

    <changeSet id="Add compound unique constraint to portfolio" author="Henri Heiskanen">
        <addUniqueConstraint tableName="portfolio"
                             columnNames="user_id, portfolio_role, language"
                             constraintName="unique_portfolio_per_user_per_role_per_lang"/>
    </changeSet>

    <changeSet id="Add Office Hours and Degree Programmes" author="Joonas Iivonen">
        <createTable tableName="office_hours">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_office_hours_user" references="user_account(id)"/>
            </column>
            <column name="name" type="varchar(255)"/>
            <column name="description" type="text"/>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
        <createTable tableName="degree_programme">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_degree_programme_user" references="user_account(id)"/>
            </column>
            <column name="degree_code" type="varchar(16)">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="Add table to keep track of portfolio component ordering" author="Henri Heiskanen">
        <createTable tableName="component_order">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="portfolio_id" type="bigint">
                <constraints nullable="false"
                             foreignKeyName="fk_component_order_portfolio"
                             references="portfolio(id)"
                             deleteCascade="true"/>
            </column>
            <column name="component" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="instance_name" type="varchar(255)">
            </column>
            <column name="order_value" type="smallint">
            </column>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>

        <addUniqueConstraint tableName="component_order"
                             columnNames="portfolio_id, order_value"
                             constraintName="unique_component_order_value_per_portfolio_id"/>
    </changeSet>

    <changeSet id="Assign UUIDs to student portfolio free_text_content entries without pre-existing instance name" author="Henri Heiskanen">
        <sql dbms="postgresql">
            UPDATE free_text_content
            SET instance_name = uuid_generate_v4()
            WHERE teacher_portfolio_section IS NULL AND instance_name IS NULL;
        </sql>
    </changeSet>

    <changeSet id="Set instance name on previously unnamed teacher portfolio free_text_content entries and matching visibilities" author="Henri Heiskanen">
        <sql>
            UPDATE free_text_content
            SET instance_name = 'GENERAL'
            WHERE teacher_portfolio_section IS NOT NULL AND instance_name IS NULL;
        </sql>

        <sql>
            UPDATE component_visibility
            SET instance_name = 'GENERAL'
            WHERE teacher_portfolio_section IS NOT NULL AND instance_name IS NULL AND component = 'FREE_TEXT_CONTENT';
        </sql>
    </changeSet>

    <changeSet id="Add component heading table" author="Joonas Iivonen">
        <createTable tableName="component_heading">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="portfolio_id" type="bigint">
                <constraints nullable="false"
                             foreignKeyName="fk_component_heading_portfolio"
                             references="portfolio(id)"
                             deleteCascade="true"/>
            </column>
            <column name="component" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="heading" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>

        <addUniqueConstraint tableName="component_heading"
                             columnNames="portfolio_id, component"
                             constraintName="unique_component_heading"/>
    </changeSet>
    <changeSet id="Remove tour columns" author="Marko Rautajoki">
        <dropColumn tableName="user_settings" columnName="show_my_studies_tour"></dropColumn>
        <dropColumn tableName="user_settings" columnName="show_my_teaching_tour"></dropColumn>
        <dropColumn tableName="user_settings" columnName="show_portfolio_tour"></dropColumn>
    </changeSet>

    <!--
        Before this patch was office_hours and degree_programme were associated with user
        separately. That way it was possible for single user to either have multiple office_hours
        but only one degree_programme or multiple_degree programmes but only one office hours.
        Latter was used.

        However, we want the user to be able to have multiple office hours, each of which
        associated with multiple degree programmes.

        Data base -wise Lets do this as follows:
        1. Add many to many join table between degree_programme and office_hours.
        2. Populate the join table
        3. Remove the direct association between user and degree_programme, as it's no more needed

        This was tested by using following dummy data:

    <changeSet id="Add dummydata to smoketest migration" author="Jussi Niskanen">
        <sql>
            INSERT INTO user_account (id, edu_person_principal_name, oodi_person_id, created_by, created_date)
            VALUES
              (1, 'opettaja@helsinki.fi', '1000', 'me', now()),
              (2, 'hybriduser@helsinki.fi', '1002', 'me', now()),
              (3, 'testteacher@helsinki.fi', '1003', 'me', now()),
              (4, 'testhybriduser@helsinki.fi', '1005', 'me', now());

            INSERT INTO user_settings(user_id, created_by, created_date)
            VALUES
                (1, 'me', now()),
                (2, 'me', now()),
                (3, 'me', now()),
                (4, 'me', now());

            INSERT INTO office_hours(user_id, name, description, created_by, created_date)
            VALUES
                (1, 'oo-name: opettaja@helsinki.fi', 'should have KH40_002, KH40_005, KH50_003 and KH50_004', 'me', now()),
                (2, 'oo-name: hybriduser@helsinki.fi', 'should have KH50_004 and KH50_005', 'me', now()),
                (3, 'oo-name: testteacher@helsinki.fi', 'should have no programmes', 'me', now()),
                (4, 'oo-name: testhybriduser@helsinki.fi', 'should have SH60_035', 'me', now());

            INSERT INTO degree_programme (user_id, degree_code, created_by, created_date)
            VALUES
                (1, 'KH40_002', 'me', now()),
                (1, 'KH40_005', 'me', now()),
                (1, 'KH50_003', 'me', now()),
                (1, 'KH50_004', 'me', now()),
                (2, 'KH50_004', 'me', now()),
                (2, 'KH50_005', 'me', now()),
                (4, 'SH60_035', 'me', now());
        </sql>
    </changeSet>

    -->

    <changeSet id="User may have multiple associated office hours each of which having multiple degree_programmes" author="Jussi Niskanen">

        <createTable tableName="office_hours_degree_programme">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="office_hours_id" type="bigint" >
                <constraints foreignKeyName="fk_office_hours_degree_programme_office_hours"
                    references="office_hours(id)" nullable="false" deleteCascade="true"/>
            </column>
            <column name="degree_programme_id" type="bigint">
                <constraints foreignKeyName="fk_office_hours_degree_programme_degree_programme"
                    references="degree_programme(id)" nullable="false" deleteCascade="true"/>
            </column>
        </createTable>

        <addUniqueConstraint
            constraintName="uc_office_hours_id__degree_programme_id"
            tableName="office_hours_degree_programme"
            columnNames="office_hours_id, degree_programme_id" />

        <sql>
            INSERT INTO office_hours_degree_programme (
                office_hours_id,
                degree_programme_id
            )
            SELECT DISTINCT office_hours.id, degree_programme.id
            FROM office_hours
            INNER JOIN degree_programme on office_hours.user_id = degree_programme.user_id;
        </sql>

        <dropColumn tableName="degree_programme" columnName="user_id" />

    </changeSet>

    <changeSet id="OO-969 Add new fields to office hours" author="Jussi Niskanen">
        <addColumn tableName="office_hours">
            <column name="additional_info" type="text" />
            <column name="location" type="text"  />
        </addColumn>
    </changeSet>

    <changeSet id="Add notification tables" author="Marko Rautajoki">
        <createTable tableName="notifications">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="localized_text_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_notification_localized_text" referencedColumnNames="localized_text(id)"/>
            </column>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>

        <createTable tableName="notification_schedules">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="notification_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_notification_schedule_notification" references="notifications(id)" deleteCascade="true"/>
            </column>
            <column name="start_date" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="end_date" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(255)"/>
            <column name="last_modified_date" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="OO-938 Remove feedbacks" author="Tomi Mäkinen">
        <dropTable tableName="feedback"/>
    </changeSet>

    <changeSet id="create cached_item_updates_check table" author="Marko Rautajoki">
        <createTable tableName="cached_item_updates_check">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cache_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="last_checked" type="timestamp">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="drop hibernate_sequence if available" author="Sami Siren">
        <preConditions onFail="MARK_RAN">
            <sequenceExists sequenceName="hibernate_sequence" />
        </preConditions>
        <dropSequence sequenceName="hibernate_sequence"/>
    </changeSet>
    <changeSet id="reset sequences if sequences exists" author="Sami Siren" dbms="postgresql">
        <sql>
            select setval('cached_item_updates_check_id_seq', (select coalesce(max(id)+1, 1) from cached_item_updates_check), false);
        </sql>
        <sql>
            select setval('calendar_feed_id_seq', (select coalesce(max(id)+1,1) from calendar_feed), false);
        </sql>
        <sql>
            select setval('component_heading_id_seq', (select coalesce(max(id)+1,1) from component_heading), false);
        </sql>
        <sql>
            select setval('component_heading_id_seq', (select coalesce(max(id)+1,1) from component_heading), false);
        </sql>
        <sql>
            select setval('component_visibility_id_seq', (select coalesce(max(id)+1,1) from component_visibility), false);
        </sql>
        <sql>
            select setval('contact_information_id_seq', (select coalesce(max(id)+1,1) from contact_information), false);
        </sql>
        <sql>
            select setval('degree_id_seq', (select coalesce(max(id)+1,1) from degree), false);
        </sql>
        <sql>
            select setval('degree_programme_id_seq', (select coalesce(max(id)+1,1) from degree_programme), false);
        </sql>
        <sql>
            select setval('favorite_id_seq', (select coalesce(max(id)+1,1) from favorite), false);
        </sql>
        <sql>
            select setval('free_text_content_id_seq', (select coalesce(max(id)+1,1) from free_text_content), false);
        </sql>
        <sql>
            select setval('job_search_id_seq', (select coalesce(max(id)+1,1) from job_search), false);
        </sql>
        <sql>
            select setval('language_proficiency_id_seq', (select coalesce(max(id)+1,1) from language_proficiency), false);
        </sql>
        <sql>
            select setval('localized_text_id_seq', (select coalesce(max(id)+1,1) from localized_text), false);
        </sql>
        <sql>
            select setval('notification_schedules_id_seq', (select coalesce(max(id)+1,1) from notification_schedules), false);
        </sql>
        <sql>
            select setval('notifications_id_seq', (select coalesce(max(id)+1,1) from notifications), false);
        </sql>
        <sql>
            select setval('office_hours_degree_programme_id_seq', (select coalesce(max(id)+1,1) from office_hours_degree_programme), false);
        </sql>
        <sql>
            select setval('office_hours_id_seq', (select coalesce(max(id)+1,1) from office_hours), false);
        </sql>
        <sql>
            select setval('persistent_audit_event_event_id_seq', (select coalesce(max(event_id)+1,1) from persistent_audit_event), false);
        </sql>
        <sql>
            select setval('portfolio_id_seq', (select coalesce(max(id)+1,1) from portfolio), false);
        </sql>
        <sql>
            select setval('portfolio_keyword_id_seq', (select coalesce(max(id)+1,1) from portfolio_keyword), false);
        </sql>
        <sql>
            select setval('portfolio_keyword_relationship_id_seq', (select coalesce(max(id)+1,1) from portfolio_keyword_relationship), false);
        </sql>
        <sql>
            select setval('sample_id_seq', (select coalesce(max(id)+1,1) from sample), false);
        </sql>
        <sql>
            select setval('some_link_id_seq', (select coalesce(max(id)+1,1) from some_link), false);
        </sql>
        <sql>
            select setval('study_attainment_whitelist_entry_id_seq', (select coalesce(max(id)+1,1) from study_attainment_whitelist_entry), false);
        </sql>
        <sql>
            select setval('study_attainment_whitelist_id_seq', (select coalesce(max(id)+1,1) from study_attainment_whitelist), false);
        </sql>
        <sql>
            select setval('todo_item_id_seq', (select coalesce(max(id)+1,1) from todo_item), false);
        </sql>
        <sql>
            select setval('useful_link_id_seq', (select coalesce(max(id)+1,1) from useful_link), false);
        </sql>
        <sql>
            select setval('user_id_seq', (select coalesce(max(id)+1,1) from user_account)), false);
        </sql>
        <sql>
            select setval('user_notification_id_seq', (select coalesce(max(id)+1,1) from user_notification), false);
        </sql>
        <sql>
            select setval('user_settings_id_seq', (select coalesce(max(id)+1,1) from user_settings), false);
        </sql>
        <sql>
            select setval('work_experience_id_seq', (select coalesce(max(id)+1,1) from work_experience), false);
        </sql>
    </changeSet>
    <changeSet id="add flamma defaults for all users" author="Sami Siren">
        <sql>
            insert into favorite (user_id, type, order_index, created_by)
              select user_account.id, 'FLAMMA_NEWS', coalesce(max(order_index)+1,0), 'system' from user_account left join favorite on user_account.id = favorite.user_id GROUP BY user_account.id;
        </sql>
        <sql>
            insert into favorite (user_id, type, order_index, created_by)
              select user_account.id, 'FLAMMA_EVENTS', coalesce(max(order_index)+1,0), 'system' from user_account left join favorite on user_account.id = favorite.user_id GROUP BY user_account.id;
        </sql>
    </changeSet>

    <changeSet id="Update varchar length for degree_programme.degree_code" author="Sami Siren">
        <modifyDataType tableName="degree_programme" columnName="degree_code" newDataType="varchar(255)" />
    </changeSet>

    <changeSet id="Add column order_index into portfolio's table work_experience" author="Jukka Purma">
        <addColumn tableName="work_experience">
            <column name="order_index" type="int" />
        </addColumn>
    </changeSet>

    <changeSet id="Create default orders for work_experience" author="Jukka Purma" dbms="postgresql">
        <!-- Try this out in http://sqlfiddle.com/#!17/66293/11 . Because updateWorkexperience deletes
         and recreates all portfolio's work_experience items on each update, their ids already reflect the order in
         which they were added. (This also means that we wouldn't even need order_index yet, but the data is
         more resilient if ids won't have that kind of secret secondary function.). -->
        <sql>
            WITH subquery AS (
                SELECT id, row_number() OVER (PARTITION BY portfolio_id) AS rnum
                FROM work_experience
                ORDER BY id ASC
            )
            UPDATE work_experience
            SET order_index=subquery.rnum
            FROM subquery
            WHERE work_experience.id=subquery.id;
        </sql>
    </changeSet>

    <changeSet id="OO-1113 flexible degree date and orderable degrees" author="Joni Korhonen" dbms="postgresql">
        <renameColumn tableName="degree" oldColumnName="date_of_degree" newColumnName="date_of_degree_old" />
        <addColumn tableName="degree">
            <column name="date_of_degree" type="varchar(255)" />
            <column name="order_index" type="int" />
        </addColumn>
        <sql>
            update degree d set
                date_of_degree =
                    case when p.language = 'en' then to_char(d.date_of_degree_old, 'DD Mon YYYY')
                    else to_char(d.date_of_degree_old, 'DD.MM.YYYY')
                    end,
                order_index =
                    (select s.row - 1 from (
                        select id, row_number() over(partition by portfolio_id order by date_of_degree_old desc) as row from degree
                    ) as s where s.id = d.id)
                from portfolio p
                where d.portfolio_id = p.id;
        </sql>
        <dropColumn tableName="degree" columnName="date_of_degree_old" />
        <addNotNullConstraint tableName="degree" columnName="date_of_degree" />
    </changeSet>

    <changeSet id="OO-1113 flexible degree date and orderable degrees (h2)" author="Joni Korhonen" dbms="h2">
        <dropColumn tableName="degree" columnName="date_of_degree" />
        <addColumn tableName="degree">
            <column name="date_of_degree" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="order_index" type="int" />
        </addColumn>
    </changeSet>

    <changeSet id="OO-1114 Add institution to degrees" author="Joni Korhonen">
        <addColumn tableName="degree">
            <column name="institution" type="varchar(255)" />
        </addColumn>
    </changeSet>
</databaseChangeLog>
